Attribute VB_Name = "SpotOSLeg"
Option Explicit


Public Sub testGetOwnshipLegs()
    Debug.Print "testGetOwnshipLegs"

    ' get the data
    Dim osData As Leg
    Set osData = loadOwnship()
    
    If (osData.bearings.Count <> 20858) Then
        Debug.Print "len is wrong:" & osData.bearings.Count
    End If
    
    Const turnThreshold = 80
    Const steadyThreshold = 70
    Const steadyWait = 320
    
    ' get ready to store results
    Dim osLegs As Collection
    Set osLegs = sliceOwnship(osData, turnThreshold, steadyThreshold, steadyWait)
    
    outputTurns osLegs
    Exit Sub
    
    Dim oLeg As OwnshipLeg
    Debug.Print "0, 0"
    For Each oLeg In osLegs
        Debug.Print oLeg.StartTime & ", 0"
        Debug.Print oLeg.StartTime & ", 20"
        Debug.Print oLeg.EndTime & ", 20"
        Debug.Print oLeg.EndTime & ", 0"
    Next oLeg
    
End Sub


Private Function sliceOwnship(osData As Leg, turnThreshold As Double, _
                         steadyThreshold As Double, steadyWait As Long) As Collection
    Dim res As Collection
    Set res = New Collection

    Dim lastSign As Integer
    Dim lastInversion As Long

    Dim lastTime As Long
    Dim lastCourse As Double
    
    Dim runningTotal
    
    ' keep track of how long we continue checking for a final wiggle
    Dim checkEndUntil As Long
    
    ' keep track of when the leg probably finished
    Dim probableEnd As Long
    Dim legStart As Long
        
    Dim inTurn As Boolean
    inTurn = False

    Dim ctr As Long
    For ctr = 1 To osData.times.Count
'    For ctr = 1 To 12000
        Dim thisT As Long
        thisT = osData.times.Item(ctr)
        Dim course As Double
        course = osData.bearings.Item(ctr)
        
      '  Debug.Print course
        
        If (ctr > 1) Then
            Dim deltaTime As Long
            Dim deltaCourse As Double
            
            deltaTime = thisT - lastTime
            deltaCourse = course - lastCourse
        
            ' calculate the diff
            Dim thisBRate As Double
            thisBRate = (deltaCourse) / (deltaTime)
        
            ' calculate the sign
            Dim thisSign As Integer
            thisSign = Sgn(thisBRate)
            
            ' has it changed?
            If (thisSign <> lastSign) Then
                ' are we in a large turn?
                If inTurn Then
                    ' are we waiting for a steady state?
                    If (checkEndUntil > 0) Then
                        If (thisT < checkEndUntil) Then
                            ' ok, we still have to carry on checking.
                            
                            ' ok, is this still a perturbation we're interested in?
                            If (runningTotal > steadyThreshold) Then
                                ' ok, we need a new steady time
                                checkEndUntil = thisT + steadyWait
                                
                                probableEnd = thisT
                            Else
                                ' ok, we just carry on waiting
                     '           Debug.Print "ignoring zig with total:" & runningTotal
                            End If
                        Else
                            ' ok, time up. we can use the finish time
                        
                        End If
                        
                    Else
                        ' ok, we've finished our large turn. track when we continue tracking until
                        checkEndUntil = thisT + steadyWait
                        
                        probableEnd = thisT
                        
                        ' track this end as the probable end, in case we get another one
                        lastInversion = thisT
                    End If
                    
                Else
                End If
                
              '  Debug.Print "Inversion at:" & lastInversion & " was:" & lastSign & " total:" & runningTotal
                                    
                ' track this oscillation
                lastInversion = thisT
                                    
                ' remember it happened
                lastSign = thisSign
                                
                ' and clear the area
                runningTotal = 0
            Else
                ' build up the running total
                runningTotal = runningTotal + Abs(deltaTime * deltaCourse)
                
                If inTurn Then
                    ' ok, has the time elapsed?
                    If checkEndUntil > 0 Then
                        If thisT >= checkEndUntil Then
                            ' ok, elapsed. store the data
                            Debug.Print "started at:" & legStart & " ended at:" & probableEnd & " was:" & Int(runningTotal)
                            inTurn = False
                            
                            checkEndUntil = 0
                            
                            ' and store it
                            Dim newLeg As OwnshipLeg
                            Set newLeg = New OwnshipLeg
                            newLeg.StartTime = legStart
                            newLeg.EndTime = probableEnd
                            res.add newLeg
                        End If
                    End If
                End If
                
                ' hey, is this a big turn?
                If (runningTotal > turnThreshold) And Not inTurn Then
               '     Debug.Print "Turn started at:" & lastInversion & " total now:" & runningTotal
                    inTurn = True
                    
                    ' ok, the leg started at the time of the last inversion
                    legStart = lastInversion
                End If

            End If
            
        End If
        
        ' ok, capture the state
        lastTime = thisT
        lastCourse = course
       
    Next ctr
    
    Set sliceOwnship = res
End Function


Private Function loadOwnship() As Leg
    Dim res As Leg
    Set res = Factory.createLeg("OS")
    
    Dim rng As Range
'     Set rng = ActiveWorkbook.Sheets("Scen1_States").Range("A3:I27243")
    Set rng = ActiveWorkbook.Sheets("Scen1_States").Range("R3:U20860")
    Dim thisR As Range
    For Each thisR In rng.Rows
        Dim elapsed As Long
        elapsed = thisR.Cells(1, 1).value
        Dim course As Double
        course = thisR.Cells(1, 4).value
        
        res.times.add elapsed
        res.bearings.add course
        
    Next thisR
    
    Set loadOwnship = res
    
End Function

Private Sub outputTurns(oLegs As Collection)
    
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    
    Dim rng As Range
    Set rng = ActiveWorkbook.Sheets("Scen1_States").Range("W3:X20860")
    rng.Clear
    Dim thisLeg As OwnshipLeg
    Dim ctr
    ctr = 1
    For Each thisLeg In oLegs
        rng.Cells(ctr, 1).value = thisLeg.StartTime
        rng.Cells(ctr, 2).value = 0
        rng.Cells(ctr + 1, 1).value = thisLeg.StartTime
        rng.Cells(ctr + 1, 2).value = 20
        rng.Cells(ctr + 2, 1).value = thisLeg.EndTime
        rng.Cells(ctr + 2, 2).value = 20
        rng.Cells(ctr + 3, 1).value = thisLeg.EndTime
        rng.Cells(ctr + 3, 2).value = 0
        
        ctr = ctr + 4
    Next thisLeg
    
    Application.ScreenUpdating = True
    Application.Calculation = xlCalculationAutomatic

End Sub

